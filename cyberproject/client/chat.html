<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Secure Chat</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #0f111a;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .chat-wrapper {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 900px;
      height: 95vh;
      background: #1c1e26;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 30px rgba(0,0,0,0.6);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: #101218;
      border-bottom: 1px solid #2c2f3a;
    }

    .header h2 {
      margin: 0;
      color: #3d5afe;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-buttons {
      display: flex;
      gap: 10px;
    }

    .btn {
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: 0.2s;
    }

    .qr-btn { background: #28a745; }
    .qr-btn:hover { background: #218838; }

    .logout-btn { background: #dc3545; }
    .logout-btn:hover { background: #c82333; }

    .chat-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
      background-color: #14161f;
    }

    /* --- NEW MESSAGE STYLING --- */
    .message-wrapper {
      display: flex;
      flex-direction: column;
      max-width: 80%;
      margin-bottom: 10px;
    }

    .message-wrapper.sent {
      align-self: flex-end;
      align-items: flex-end;
    }

    .message-wrapper.received {
      align-self: flex-start;
      align-items: flex-start;
    }

    .sender-name {
      font-size: 12px;
      color: #8b9bb4;
      margin-bottom: 4px;
      margin-left: 4px;
    }

    .dual-message-card {
      background: #23262f;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #2c2f3a;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      width: 100%;
    }

    /* Decrypted (Readable) Section */
    .decrypted-block {
      padding: 12px 15px;
      background: #1e2029; /* Slightly darker than card */
      border-bottom: 1px solid #2c2f3a;
    }
    
    .decrypted-block.sent-style {
         background: #3d5afe; /* Blue background for sent messages */
         color: white;
    }

    .block-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 5px;
      opacity: 0.7;
    }

    .readable-text {
      font-size: 15px;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    /* Encrypted (Ciphertext) Section */
    .encrypted-block {
      padding: 10px 15px;
      background: #000000;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #28a745; /* Matrix Green */
      border-top: 1px solid #333;
    }

    .cipher-text {
      word-break: break-all;
      opacity: 0.9;
    }

    .timestamp {
      font-size: 10px;
      color: #666;
      margin-top: 5px;
      text-align: right;
      padding-right: 5px;
    }

    /* --- INPUT BAR --- */
    .input-bar {
      display: flex;
      align-items: center;
      padding: 15px;
      background: #1c1e26;
      border-top: 1px solid #2c2f3a;
      gap: 10px;
    }

    .input-bar input[type="text"] {
      flex: 1;
      padding: 12px 15px;
      border-radius: 25px;
      background: #101218;
      border: 1px solid #2c2f3a;
      color: white;
      outline: none;
      font-size: 15px;
    }

    .input-bar input[type="text"]:focus {
      border-color: #3d5afe;
    }

    .icon-btn {
      background: #2c2f3a;
      border: none;
      color: #aaa;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: 0.2s;
    }

    .icon-btn:hover {
      background: #3d5afe;
      color: white;
    }
    
    .send-btn {
        background: #3d5afe;
        color: white;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
      z-index: 2000;
      color: white;
      font-size: 14px;
      animation: slideIn 0.3s ease-out;
    }
    
    .notification.success { background: #28a745; }
    .notification.warning { background: #ffc107; color: #1c1e26; font-weight: bold;}
    .notification.error { background: #dc3545; }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* QR Modal */
    .qr-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      backdrop-filter: blur(5px);
    }

    .qr-content {
      background-color: #1c1e26;
      margin: 10% auto;
      padding: 25px;
      border-radius: 16px;
      width: 320px;
      text-align: center;
      border: 1px solid #3d5afe;
    }

    .qr-content img {
      border-radius: 8px;
      margin: 15px 0;
      border: 5px solid white;
    }
    
    .close {
        float: right;
        cursor: pointer;
        font-size: 20px;
    }
  </style>
</head>
<body>
  <div class="chat-wrapper">
    <div class="header">
      <h2>üõ°Ô∏è Secure Chat <span style="font-size:12px; background:#28a745; padding:2px 6px; border-radius:4px; color:white; margin-left:10px;">AES-256 Active</span></h2>
      <div class="header-buttons">
        <button class="btn qr-btn" onclick="copyInvite()">üîó Invite</button>
        <button class="btn logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>
    
    <div class="chat-container" id="chat-box">
      <!-- Messages will appear here -->
      <div style="text-align:center; color:#555; font-size:13px; margin-top:20px;">
         Start of encrypted session
      </div>
    </div>

    <div class="input-bar">
      <input type="file" id="file-input" onchange="handleFileSelect(event)" accept="*/*" style="display:none;">
      <button class="icon-btn" onclick="document.getElementById('file-input').click()" title="Attach file">üìé</button>
      <input type="text" id="message-input" placeholder="Type a secure message..." onkeypress="handleKeyPress(event)">
      <button class="icon-btn send-btn" onclick="sendMessage()" title="Send message">‚û§</button>
    </div>
  </div>
  
  <div id="notification-container"></div>

  <div id="qrModal" class="qr-modal">
    <div class="qr-content">
      <span class="close" onclick="closeQRModal()">&times;</span>
      <h3>üîê Secure QR Code</h3>
      <div id="qrImage"></div>
      <p style="color:#8b9bb4; font-size:13px;">Scan to join session securely.</p>
    </div>
  </div>

  <script>
    let websocket = null;
    let currentUser = '';
    let sessionId = null;
    let selectedFile = null;
    
    // Check auth and connect
    window.addEventListener('load', function() {
      const token = localStorage.getItem('authToken');
      if (!token) { window.location.href = '/static/login.html'; return; }
      
      currentUser = localStorage.getItem('userEmail') || 'user@example.com';
      const params = new URLSearchParams(window.location.search);
      sessionId = params.get('session_id');
      
      if (!sessionId) {
        alert('No session ID found.');
        return;
      }

      connectWebSocket(token, sessionId);
    });

    function connectWebSocket(token, sessionId) {
      if (websocket) return;

      // Mobile/Production SSL Fix
      const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${wsProtocol}//${window.location.host}/ws/${sessionId}?token=${token}`;
      
      console.log("Connecting to:", wsUrl);
      websocket = new WebSocket(wsUrl);
      
      websocket.onopen = () => console.log('Connected');
      
      websocket.onmessage = function(event) {
        try {
          const data = JSON.parse(event.data);
          
          // Handle different message types
          if (data.warning) {
             // Show red warning card
             addSecurityWarning(data.user, data.message, data.security_info);
          } else if (data.terminated) {
             alert(data.message);
             window.location.href = '/static/index.html';
          } else if (data.encrypted === false) {
             // Standard Message: Show Decrypted + Encrypted View
             addDualMessage(data.user, data.message, data.ciphertext);
          } else {
             // Encrypted only (Legacy fallback)
             addDualMessage(data.user, "Message encrypted", data.message); 
          }
        } catch (e) { console.error(e); }
      };
      
      websocket.onclose = (e) => {
          if(e.code === 1008) { alert("Session closed by server."); logout(); }
          else { console.log("Disconnected"); }
      };
    }

    function sendMessage() {
      const input = document.getElementById('message-input');
      const text = input.value.trim();
      if (!text) return;
      
      // Optimistic UI Update (Show sent message immediately)
      // We fake the ciphertext for the sender's view or wait for server echo?
      // Usually better to wait for server echo for accurate ciphertext display, 
      // but for responsiveness we can show it.
      // NOTE: Server broadcasts the message back, so we let onmessage handle it
      // to ensure we display the server-generated ciphertext.
      
      if (websocket && websocket.readyState === WebSocket.OPEN) {
        websocket.send(JSON.stringify({ user: currentUser, message: text }));
      }
      input.value = '';
    }

    function handleKeyPress(e) { if (e.key === 'Enter') sendMessage(); }

    // --- THE NEW DUAL MESSAGE DISPLAY ---
    function addDualMessage(user, readableText, cipherText) {
        const chatBox = document.getElementById('chat-box');
        const wrapper = document.createElement('div');
        const isMe = user === currentUser;
        
        wrapper.className = `message-wrapper ${isMe ? 'sent' : 'received'}`;
        
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const shortCipher = cipherText ? cipherText : "Encrypted Data unavailable";
        
        // Different style for "Sent" vs "Received" decrypted block
        const decryptedClass = isMe ? 'decrypted-block sent-style' : 'decrypted-block';
        
        wrapper.innerHTML = `
            <div class="sender-name">${isMe ? 'You' : user}</div>
            <div class="dual-message-card">
                <!-- 1. Readable Content -->
                <div class="${decryptedClass}">
                    <div class="block-label">üìÑ Original Message:</div>
                    <div class="readable-text">${readableText}</div>
                </div>
                
                <!-- 2. Encrypted Content -->
                <div class="encrypted-block">
                    <div class="block-label">üîí Encrypted (AES-256):</div>
                    <div class="cipher-text">${shortCipher}</div>
                </div>
            </div>
            <div class="timestamp">${time}</div>
        `;
        
        chatBox.appendChild(wrapper);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function addSecurityWarning(user, text, info) {
        const chatBox = document.getElementById('chat-box');
        const wrapper = document.createElement('div');
        wrapper.className = 'message-wrapper received';
        
        wrapper.innerHTML = `
             <div class="sender-name">Security System</div>
             <div class="dual-message-card" style="border: 1px solid #ffc107;">
                <div class="decrypted-block" style="background: #332b00; color: #ffc107;">
                    <div class="block-label">‚ö†Ô∏è SECURITY ALERT</div>
                    <div class="readable-text">${text}</div>
                </div>
                <div class="encrypted-block">
                    <div class="block-label">‚ÑπÔ∏è Info:</div>
                    <div class="cipher-text">${info}</div>
                </div>
             </div>
        `;
        chatBox.appendChild(wrapper);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // ... Keep existing utility functions (copyInvite, logout, file handling) ...
    function copyInvite() {
      if (!sessionId) return;
      const link = `${window.location.origin}/static/chat.html?session_id=${sessionId}`;
      navigator.clipboard.writeText(link).then(() => alert('Link copied!'));
    }

    function logout() {
      localStorage.clear();
      window.location.href = '/static/login.html';
    }
    
    function handleFileSelect(e) {
        // Simplified file handler for this view
        alert("File upload logic would go here (same as previous version)");
    }

    // QR Code Logic
    async function loadQR() {
         // ... same as previous ...
    }
    window.addEventListener('load', async function() {
      const params = new URLSearchParams(window.location.search);
      const sid = params.get('session_id');
      if(sid) {
          try {
             const r = await fetch(`/qr_from_session/${sid}`);
             if(r.ok) {
                 const b = await r.blob();
                 document.getElementById('qrImage').innerHTML = `<img src="${URL.createObjectURL(b)}" width="200">`;
             }
          } catch(e){}
      }
    });
    
    function closeQRModal() { document.getElementById('qrModal').style.display = 'none'; }
  </script>
</body>
</html>
